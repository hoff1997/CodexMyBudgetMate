# Security & Penetration Test Readiness Checklist

## Overview

This document tracks security measures implemented for Akahu certification and general security best practices. Use this checklist before commissioning a penetration test.

**Last Updated:** January 2026

---

## Pre-Penetration Test Checklist

### Critical (Must Fix Before Testing)

- [x] **Secrets Rotation** - All exposed credentials have been rotated
  - [ ] Supabase anon key (regenerate in dashboard)
  - [ ] Supabase service role key (regenerate in dashboard)
  - [ ] Supabase JWT secret (regenerate in dashboard)
  - [ ] Upstash Redis token (create new database or regenerate)
  - [ ] Google OAuth client secret (regenerate in Google Cloud Console)
  - [ ] Generate new KID_SESSION_SECRET: `openssl rand -hex 32`
  - [ ] Generate new CSRF_SECRET: `openssl rand -hex 32`
  - [ ] Generate new CRON_SECRET: `openssl rand -hex 32`

- [x] **Audit Mode Removed** - Authentication bypass removed from middleware
  - File: `middleware.ts`
  - The `NEXT_PUBLIC_AUDIT_MODE` bypass has been completely removed

- [x] **Environment Variables Secured**
  - `.env.local` is in `.gitignore`
  - No hardcoded fallback secrets
  - All security-critical env vars fail hard if missing

### High Priority (Required for Akahu Certification)

- [x] **Security Headers Implemented** (`next.config.mjs`)
  - [x] X-Frame-Options: DENY
  - [x] X-Content-Type-Options: nosniff
  - [x] X-XSS-Protection: 1; mode=block
  - [x] Referrer-Policy: strict-origin-when-cross-origin
  - [x] Strict-Transport-Security (HSTS)
  - [x] Content-Security-Policy
  - [x] Permissions-Policy

- [x] **CSRF Protection**
  - File: `lib/utils/csrf.ts`
  - HMAC-SHA256 token generation
  - 1-hour token expiry
  - HttpOnly cookie with strict SameSite
  - No fallback secrets (fails secure)

- [x] **Rate Limiting** (`lib/utils/rate-limiter.ts`)
  - Per-target rate limiting (5 attempts, escalating lockout)
  - Global IP rate limiting (20 attempts)
  - Database persistence
  - Applied to kids login endpoint

- [x] **Session Security**
  - HttpOnly cookies
  - Secure flag in production
  - SameSite: lax (or strict for CSRF-protected routes)
  - HMAC-signed kid sessions
  - No fallback secrets

### Medium Priority (Recommended Before Testing)

- [x] **Error Message Sanitization**
  - File: `lib/utils/api-error.ts`
  - Database errors are sanitized before client exposure
  - Sensitive schema information is never exposed
  - Pattern: Use `createErrorResponse()` instead of `error.message`

- [x] **Input Validation**
  - Zod schemas for all API inputs
  - Field whitelisting in PATCH operations
  - UUID validation for IDs

- [x] **Query Limit Validation**
  - Max limit checks (100) on paginated endpoints
  - Prevents DoS via unbounded queries
  - Applied to: notifications, kids/[childId]/transfer-requests, kids/[childId]/spending, envelopes/history

- [x] **Explicit Column Selection**
  - Replace `select("*")` with explicit columns
  - Prevents accidental data exposure

### Akahu-Specific Requirements

- [x] **OAuth Implementation**
  - State parameter with timestamp + random value
  - 10-minute state expiry
  - State stored in database
  - User ID included in state to prevent token swapping

- [x] **Token Management**
  - Tokens stored server-side only
  - Automatic token refresh with expiry buffer
  - Token revocation detection (401/403 handling)
  - Audit logging for token operations

- [x] **MFA Implementation**
  - TOTP via Supabase native MFA
  - Backup codes support
  - Session timeout compliance

- [x] **MFA Enforcement on Sensitive Routes**
  - File: `middleware.ts`
  - Middleware enforces MFA re-verification on:
    - `/api/akahu/*` (bank connections)
    - `/api/2fa/*` (security settings, except verify endpoints)
  - Returns 403 with `code: "MFA_REQUIRED"` when MFA session expired
  - 2-hour session timeout as per Akahu requirements

---

## Security Architecture

### Authentication Flow

```
User → Supabase Auth → Session Cookie → Middleware → API Route
                                            ↓
                                    Session Refresh
                                            ↓
                                    Row Level Security
```

### Kids Module Authentication

```
Child → PIN Entry → Rate Limit Check → CSRF Validation → PIN Verify
                                                              ↓
                                                    HMAC-Signed Session
                                                              ↓
                                                    HttpOnly Cookie
```

### Akahu OAuth Flow

```
User → Start OAuth → Generate State → Store in DB → Redirect to Akahu
                                                          ↓
Callback ← Verify State ← Exchange Code → Store Tokens → Redirect
```

---

## Files Changed for Security

| File | Changes |
|------|---------|
| `middleware.ts` | Removed audit mode bypass, no fallback secrets, MFA enforcement on sensitive routes |
| `next.config.mjs` | Added security headers, restricted allowedOrigins |
| `lib/utils/csrf.ts` | Removed fallback secret, added validation |
| `lib/utils/kid-session.ts` | Removed fallback secret, fail secure |
| `lib/utils/api-error.ts` | NEW - Error sanitization utilities |
| `app/api/envelopes/route.ts` | Sanitized error responses |
| `app/api/accounts/route.ts` | Explicit columns, sanitized errors |
| `.env.example` | Updated with security documentation |
| `.env.local` | Cleared exposed secrets (must regenerate) |

---

## Penetration Testing Scope

### In Scope
- All authenticated routes under `/app/(app)/`
- All API routes under `/api/`
- Kids module authentication and authorization
- Akahu OAuth flow
- Session management
- Input validation
- Authorization checks

### Out of Scope
- Supabase infrastructure
- Vercel infrastructure
- Third-party services (Akahu, Upstash)

---

## Post-Pentest Actions

1. Review all findings and categorize by severity
2. Create remediation plan with timelines
3. Fix critical/high issues before retest
4. Document any accepted risks
5. Update this checklist with new findings

---

## Akahu Certification Submission Checklist

- [ ] Penetration test completed by NZ-based security firm
- [ ] All critical/high findings remediated
- [ ] Privacy policy published (https://mybudgetmate.co.nz/privacy)
- [ ] Consumer information page (https://mybudgetmate.co.nz/about/bank-connection)
- [ ] MFA implementation documented
- [ ] Session timeout compliance (2 hours max)
- [ ] Token revocation handling documented
- [ ] Demo account created for Akahu reviewers
- [ ] Application submitted via Akahu developer portal

---

## Contact for Security Issues

Report security vulnerabilities to: [security contact email]

Do NOT create public GitHub issues for security vulnerabilities.
